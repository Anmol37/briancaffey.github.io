---

layout: post
title: Capital One Code < FAM /> Hackathon recap
date: 2017-11-05
comments: true
image: /static/capital_one.png

---

Over the weekend I participated in the Capital One's **Code < FAM />** hackathon at the National Union Building. After the kickoff event I formed a team with 5 other hackathon attendees. We were interested in applying [contingency management theory](https://en.wikipedia.org/wiki/Contingency_management) to teenagers who are just starting to build credit. One of my teammates is a data scientist who studied psycology at the PhD level and has published several papers on the topic of contingency management for substance abuse.

**Challenge the Future of Family Finances** was the theme for the event, so as *Team Contingency*, we set out to create an app called *Contingency* to help teenagers better manage their finances with techniques from contingency managment (CM). Here's a snippet from Wikipedia on CM:

> CM refers to the application of the three-term contingency (or operant conditioning), which uses stimulus control and positive reinforcement to change behavior. Patients' behaviors are rewarded (or, less often, punished); generally, adherence to or failure to adhere to program rules and regulations or their treatment plan. CM derives from the science of applied behavior analysis (ABA), and by most evaluations, its procedures produces one of the largest effect sizes out of all mental health and educational interventions.

Our app rewards young families for making sound purchases. The app allows for primary users (parents) to rate each transaction on an authorized user's credit card (where authorized user refers to teenagers). By consistantly making responsible purchases over a prolonged period of time, an authorized user's credit will increase. When an authorized user makes "bad" purchases, their credit limit is significantly reduced. 

Here are some screen shots from the final version of our app:

![png](/static/capitalone/capitalone_contingency_1.png)

I have limited experience with React, but my team was lucky to have two front end wizards put this interface together with React.js libraries. The charts show expenditures for multiple authorized users on an account as well as the credit limit generated by the ratings of their previous transactions. 

The link to the demo is [capitalone2017.surge.sh](capitalone2017.surge.sh). Here is another screenshot looking at the recent transactions of one authorized user and buttons that a parent can toggle to rate transactions as "responsible" or "not responsible".

![png](/static/capitalone/capitalone_contingency_2.png)

I worked on the backend webserver that provided data for the React.js interface. This was an awesome learning experience since I did things with Django and Python that I haven't done before (at least not trivially), namely multithreading and working with MongoDB. 

## Multithreading

Becuase of the way Capital One's API was structured, we needed to make post requests to get data on a given customer. [Here](https://github.com/CapitalOne-AU-Hackathon/au-hackathon-getting-started/blob/master/API_Getting_Started.md) is the documentation for the API. Since we wanted to show transactions from all related users (primary and authorized accounts), this required making lots of individual requests. To speed this up, we used Python's [`ThreadPoolExecutor`](https://docs.python.org/3/library/concurrent.futures.html) to make requests in parallel rather than looping over each authorized user and making requests one at a time. Here's what this looks like in our code: 

```python
from concurrent.futures import ThreadPoolExecutor
[...]
            with ThreadPoolExecutor() as executor:
                filled_customers = executor.map(map_to_get_customer, customers,
                                                timeout=3)
[...]

```

This is part of a Django endpoint in which we make external calls to Capital One's API. [Here](https://github.com/briancaffey/capital-one-backend/blob/master/api/views.py) is the full file containing this view on my GitHub repo. Another teammate did a fantastic job putting together a collection of functions that would allow us to query the API data in many different ways, as well as write data to it, but our final demo only used one function. [Here](https://github.com/briancaffey/capital-one-backend/blob/master/api/utils.py) is the file with that collection of functions. 

## MongoDB

We used MongoDB to cache data from the API and also add additional information to each transaction for authorized users (including the "rating" for each transaction, a boolean value for whether or not the transaction was responsible). 

Here's a look at how we updated the MongoDB database. From front-end we would send a request to an endpoint that would call the following function (along with data in the body about what we are updating, such as: `{"customer_id": 100720000, "transaction_id": 100720002, "rating": false}`.

*[api/views.py -- `update_transaction()`](https://github.com/briancaffey/capital-one-backend/blob/master/api/views.py#L56)*
```python
def update_transaction(request):
    body = json.loads(request.body.decode())

    customer_id = int(body["customer_id"])
    transaction_id = int(body["transaction_id"])
    rating = body["rating"]
    try:
        transactions = users.find_one({"customer_id": int(customer_id)})[
            "transactions"]

        updated_transactions = []
        for transaction in transactions:
            if transaction["transaction_id"] == transaction_id:
                updated_transactions.append({**transaction, "rating": rating})
            else:
                updated_transactions.append(transaction)

        response = users.update_one({"customer_id": customer_id}, {
            "$set": {"transactions": updated_transactions}})

        response = f'{response.modified_count} item(s) were updated'
        return JsonResponse({"status": response})

    except KeyError as error:

        return JsonResponse({"error": "failed to find record"})
```

Overall it was a great hackathon and I was really impressed with some of the other projects. Thanks to Capital One and BeMyApp for putting the event together. 